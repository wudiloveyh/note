[toc]

# 内网渗透总体流程

1. 外网入口获取
2. 进入内网落地/建立稳定权限
3. 信息收集（主机、网络、服务、域）
4. 权限提升（windows/linux）
5. 横向移动（凭据+协议+服务）
6. 域控攻击（Kerberos/LDAP/AD）
7. 权限维持（持久化）
8. 痕迹清除/反溯源

# 内网入口

- 弱口令
  - RDP
  - SSH
  - SMB
  - MSSQL
  - Redis
  - MySQL
- 外网漏洞打点
  - web漏洞（RCE、文件上传、SQL注入等）
  - 业务系统漏洞（OA、VPN、堡垒机）
- 钓鱼攻击
  - office宏
  - LNK
  - HTA
  - Powershell Download Cradle
- 第三方组件漏洞
  - Log4j
  - Confluence
  - Exchange ProxyLogon

# 内网信息收集

- 主机信息
  - 系统版本
  - 补丁情况
  - 开放端口、服务
  - 进程信息
  - 软件安装情况
- 网络信息
  - 本机IP地址、网段、掩码、网关
  - vlan情况
  - 路由表
  - DNS
  - 内部代理
- 域环境信息
  - 是否加入域
  - 域控IP
  - 域SID
  - Kerberos策略
  - 域用户、域管理员
- 基础服务信息
  - SMB、WMI、RDP可访问情况
  - MSSQL是否开放
  - Web服务情况

# 权限提升方式

分为windows和linux

## windows提权方法

1. 内核漏洞（MS16-032、MS17-010）
2. Token提权(Impersonation)
3. 服务器配置错误
4. DDL劫持
5. 组策略错误配置
6. UAC绕过
7. Credential Dumping(获取密码)

## linux提权方法

1. SUID提权
2. 内核漏洞
3. 弱口令+sudo
4. 计划任务提权

# 权限获取的方式

## windows凭证获取

1. mimikatz（LSASS）
2. SAM文件窃取
3. DPAPI解密
4. Token复用
5. 内存抓取

## Linux凭证获取

1. /etc/shadow
2. ssh私钥
3. Web应用配置文件
4. 内存dump

# 横向移动

拿到账号后，扩张攻击范围

## windows横向方式

- SMB(IPC$、psexec)
- WMI(wmiexec)
- WinRM
- RDP
- MSSQL xp_cmdshell
- DCOM

## Linux横向方式

- SSH密钥登录
- Redis写SSH公钥
- MysqlUDF + 提权执行命令

## 工具

- CrackMapExec
- Impacket
- SharkHound(BloodHound信息收集)

# 域渗透

重点是kerberos + LDAP漏洞

1. 票据相关攻击（Kerberos）
   1. Kerberosting
   2. AS-REP Roasting
   3. Pass-the-ticket(PTT)
   4. Golden Ticket(黄金票据)
   5. Silver Tikcet(白银票据)
2. 域权限提升
   1. ACL/DACL滥用
   2. BloodHound图谱分析
   3. GPO攻击
   4. DCSync(同步域密码)
3. 域控提权方式
   1. CVE
   2. LDAP Relay
   3. Relay攻击（NTLM）

# 权限维持（后门持久化）

## windows

- 注册表启动项
- WMI event
- GPO修改
- 新建隐藏管理员用户
- Golden Ticket（持续访问）

## Linux

- ssh后门
- 计划任务
- 服务自启动
- systemd修改

# 痕迹清除

- 清除日志
- Powershell历史记录删除
- 计划任务清除
- 工具痕迹（exe、ddl、脚本）

# 常见工具体系

- 渗透框架
  - Cobalt Strike
  - MSF
  - Havoc
  - Sliver
  - Vshell
  - DayBreak
- 横向工具
  - Impacket
  - CrackMapExec
  - SharpHound
- 主机信息收集
  - winPEAS
  - linPEAS
  - Seatbelt
  - Powerview